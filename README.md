# story-song

Маркетинговый лендинг для заказа персональных песен.

## Запуск через Docker Compose

1. Создайте рядом с `docker-compose.yml` файл `.env` и добавьте в него нужные параметры (файл не попадёт в репозиторий, он уже добавлен в `.gitignore`):
   ```dotenv
   TELEGRAM_BOT_TOKEN=<ваш_токен>
   TELEGRAM_CHAT_ID=<ваш_chat_id>
   # Необязательно: общее имя для сертификата
   SSL_CERT_COMMON_NAME=songs.example.com
   ```
2. Запустите контейнеры:
   ```bash
   docker compose up --build
   ```
3. Откройте сайт по адресу [https://localhost](https://localhost). Самоподписанный сертификат создаётся автоматически при старте.

Для остановки используйте `docker compose down`.

## Развёртывание на Fly.io

Репозиторий уже содержит `Dockerfile`, `fly.toml` и `.fly/launch.toml`, поэтому Fly.io может подтянуть его и собрать образ без дополнительных команд в кодовой базе. Перед запуском деплоя убедитесь, что вы настроили приложение:

1. Задайте уникальное имя приложения: измените значение `app` в `fly.toml` и `.fly/launch.toml`, сохраните изменения и закоммитьте их.
2. Установите секреты (например, `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID`) через панель Fly.io или командой `flyctl secrets set`.
3. Если вы подключаете репозиторий к GitHub-интеграции Fly.io, выполните в каталоге проекта `flyctl launch --no-deploy`. Команда зарегистрирует приложение и сгенерирует план сборки, который затем будет использоваться автоматическими пайплайнами.

### Диагностика ошибки `launch manifest was created for a … app`

Иногда при генерации плана (`flyctl launch plan generate`), которую выполняет облачная интеграция Fly.io, может появиться сообщение вида `Error: launch manifest was created for a … app, but this is a … app`. Это означает, что `.fly/launch.toml` не совпадает с определённым Fly.io типом приложения. Чтобы устранить проблему:

1. Удалите файл `.fly/launch.toml` (или очистите его изменения) и снова запустите `flyctl launch --no-deploy --overwrite`, чтобы Fly CLI пересоздал манифест под текущий тип приложения.
2. Проверьте, что в новом `.fly/launch.toml` присутствует секция `[build]` с `dockerfile = "Dockerfile"`, и закоммитьте обновления.

После этого каждая сборка, инициированная Fly.io, успешно соберёт образ на основе `Dockerfile`, запустит контейнер и предоставит HTTPS-сертификат, проксируя запросы к внутреннему HTTP-сервису на порту 8080.
